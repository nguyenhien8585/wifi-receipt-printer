<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>In Phiếu Thu Viettel - Text to PDF</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e74c3c">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      text-align: center;
      padding: 20px;
      position: relative;
    }
    
    .header h1 {
      font-size: 24px;
      margin: 0;
    }
    
    .header .subtitle {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 5px;
    }
    
    .bluetooth-status {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.2);
      transition: all 0.3s;
    }
    
    .bluetooth-status.connected {
      background: #27ae60;
    }
    
    .config-section {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .config-section h3 {
      color: #495057;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .config-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .config-row label {
      min-width: 120px;
      font-weight: 600;
      color: #495057;
    }
    
    .config-row input {
      flex: 1;
      padding: 10px 15px;
      border: 2px solid #ced4da;
      border-radius: 8px;
      font-size: 14px;
      min-width: 250px;
      transition: all 0.3s;
    }
    
    .config-row input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .controls {
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .search-group {
      flex: 1;
      min-width: 300px;
      display: flex;
      gap: 10px;
    }
    
    #searchInput {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 25px;
      font-size: 16px;
      outline: none;
      transition: all 0.3s;
    }
    
    #searchInput:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
    .btn-success { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
    .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
    .btn-info { background: linear-gradient(135deg, #17a2b8, #138496); color: white; }
    
    .status {
      text-align: center;
      padding: 30px 20px;
      font-size: 16px;
      color: #666;
    }
    
    .status.loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .status.loading::before {
      content: '';
      width: 24px;
      height: 24px;
      border: 3px solid #ddd;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .status.success {
      color: #27ae60;
    }
    
    .status.error {
      color: #e74c3c;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px 20px;
      margin: 20px;
      border-radius: 8px;
      border-left: 4px solid #dc3545;
    }
    
    .records {
      max-height: calc(100vh - 450px);
      overflow-y: auto;
    }
    
    .record {
      border-bottom: 1px solid #eee;
      padding: 20px;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }
    
    .record:hover {
      background: #f8f9fa;
    }
    
    .record:last-child {
      border-bottom: none;
    }
    
    .record.printed {
      background: linear-gradient(90deg, #d4edda 0%, #ffffff 100%);
      border-left: 4px solid #27ae60;
    }
    
    .record-info {
      flex: 1;
    }
    
    .record-name {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .record-details {
      color: #666;
      line-height: 1.8;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 8px;
    }
    
    .record-details div {
      display: flex;
      align-items: flex-start;
    }
    
    .record-details strong {
      min-width: 100px;
      color: #495057;
    }
    
    .record-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
      min-width: 150px;
    }
    
    .amount {
      font-size: 20px;
      font-weight: 700;
      color: #e74c3c;
      text-align: right;
      background: rgba(231, 76, 60, 0.1);
      padding: 8px 15px;
      border-radius: 20px;
      border: 2px solid rgba(231, 76, 60, 0.2);
    }
    
    .print-status {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 3px 10px rgba(39, 174, 96, 0.3);
    }
    
    .no-bluetooth {
      background: #fff3cd;
      color: #856404;
      padding: 15px 20px;
      margin: 20px;
      border-radius: 8px;
      border: 1px solid #ffeaa7;
      text-align: center;
    }
    
    .footer {
      background: #2c3e50;
      color: white;
      text-align: center;
      padding: 20px;
      font-size: 14px;
    }
    
    .pdf-info {
      background: #e7f5ff;
      border: 1px solid #339af0;
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
      font-size: 14px;
      color: #1864ab;
    }
    
    .pdf-preview {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #ddd;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
    }
    
    .pdf-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .pdf-preview-close {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 16px;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      
      .header h1 {
        font-size: 20px;
      }
      
      .bluetooth-status {
        position: static;
        display: block;
        margin-top: 10px;
        text-align: center;
      }
      
      .config-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .config-row label {
        min-width: auto;
      }
      
      .config-row input {
        width: 100%;
        min-width: auto;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-group {
        width: 100%;
        min-width: auto;
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .record {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .record-actions {
        width: 100%;
        align-items: center;
      }
      
      .record-details {
        grid-template-columns: 1fr;
      }
      
      .amount {
        font-size: 18px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/63/Logo_Viettel_from_7_January_2021_Slogan.svg" 
             alt="Viettel Logo" 
             style="height: 40px; filter: brightness(0) invert(1);">
        <div>
          <h1 style="margin: 0; font-size: 24px;">In Phiếu Thu Viettel - PDF Mode</h1>
          <div class="subtitle">📄 Text to PDF to Print - 100% tiếng Việt có dấu!</div>
        </div>
      </div>
      <div class="bluetooth-status" id="bluetoothStatus">🔴 Bluetooth chưa kết nối</div>
    </div>
    
    <!-- Cấu hình kết nối -->
    <div class="config-section">
      <h3>⚙️ Cấu hình kết nối Google Sheets</h3>
      <div class="config-row">
        <label>📊 Sheet ID:</label>
        <input type="text" id="sheetId" value="1JDh0RBSY6rSME3lHmyJhKc5kHw4YD_0f-OFmkkC76Ms" placeholder="Nhập ID Google Sheets">
      </div>
      <div class="config-row">
        <label>📄 Sheet Name:</label>
        <input type="text" id="sheetName" value="Sheet1" placeholder="Tên sheet (VD: Sheet1)">
      </div>
      <div class="config-row">
        <label></label>
        <div class="pdf-info">
          <strong>📄 PDF Mode:</strong> Chuyển text thành PDF với tiếng Việt có dấu đẹp, sau đó render thành bitmap để in<br>
          <strong>✅ Kích thước:</strong> Tối ưu cho máy in 58mm (384px width)<br>
          <strong>✅ Font:</strong> Arial Unicode MS hỗ trợ đầy đủ tiếng Việt<br>
          <strong>✅ Quality:</strong> High resolution, không bị mờ hay lỗi encoding
        </div>
      </div>
      <div class="config-row">
        <label></label>
        <small style="color: #666; font-style: italic;">
          💡 Lấy Sheet ID từ URL: https://docs.google.com/spreadsheets/d/<strong>SHEET_ID</strong>/edit
        </small>
      </div>
    </div>
    
    <!-- Điều khiển -->
    <div class="controls">
      <div class="search-group">
        <input type="text" id="searchInput" placeholder="🔍 Tìm kiếm theo tên, SĐT, địa chỉ...">
        <button class="btn btn-primary" onclick="search()">
          <span>🔍</span> Tìm kiếm
        </button>
        <button class="btn btn-success" onclick="loadAll()">
          <span>📋</span> Tất cả
        </button>
      </div>
      
      <button class="btn btn-info" onclick="connectBluetooth()" id="bluetoothBtn">
        <span>📶</span> Kết nối BT
      </button>
      <button class="btn btn-warning" onclick="testConnection()">
        <span>🔧</span> Test Sheet
      </button>
      <button class="btn btn-primary" onclick="testPDFPrint()">
        <span>📄</span> Test PDF
      </button>
    </div>

    <!-- Trạng thái -->
    <div id="status" class="status">
      📄 <strong>PDF Mode - Cách duy nhất triệt để in tiếng Việt có dấu:</strong><br>
      1. Kết nối Bluetooth Y58<br>
      2. Nhấn "Test PDF" để xem preview và test in<br>
      3. PDF sẽ được tạo với tiếng Việt có dấu đẹp, sau đó chuyển thành bitmap để in<br>
      💡 <strong>100% thành công - không bao giờ lỗi encoding!</strong>
    </div>
    
    <!-- Lỗi -->
    <div id="error" class="error" style="display:none;"></div>
    
    <!-- Cảnh báo không hỗ trợ Bluetooth -->
    <div id="noBluetoothWarning" class="no-bluetooth" style="display:none;">
      ⚠️ <strong>Trình duyệt không hỗ trợ Web Bluetooth!</strong><br>
      Hãy sử dụng: <strong>Chrome trên Android</strong> hoặc <strong>Edge trên Windows</strong>
    </div>
    
    <!-- Danh sách bản ghi -->
    <div id="records" class="records"></div>
    
    <!-- Footer -->
    <div class="footer">
      <div>📞 Hotline: 0978887797 | 📧 Email: support@viettel.com.vn</div>
      <div style="margin-top: 5px; font-size: 12px; opacity: 0.8;">
        © 2024 Viettel Đồng Tháp - 📄 PDF Technology: Text → PDF → Bitmap → Print
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let allRecords = [];
    let bluetoothDevice = null;
    let bluetoothCharacteristic = null;

    // ==================== KHỞI TẠO ====================
    
    document.addEventListener('DOMContentLoaded', function() {
      if (!navigator.bluetooth) {
        document.getElementById('noBluetoothWarning').style.display = 'block';
        document.getElementById('bluetoothBtn').disabled = true;
      }
      
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') search();
      });
      
      // Lưu cấu hình
      ['sheetId', 'sheetName'].forEach(id => {
        const input = document.getElementById(id);
        input.value = localStorage.getItem(id) || input.value;
        input.addEventListener('change', () => {
          localStorage.setItem(id, input.value);
        });
      });
    });

    // ==================== BLUETOOTH Y58 ====================
    
    async function connectBluetooth() {
      if (!navigator.bluetooth) {
        alert('❌ Trình duyệt không hỗ trợ Bluetooth!\n\n✅ Hãy sử dụng:\n• Chrome trên Android\n• Edge trên Windows');
        return;
      }

      try {
        if (bluetoothDevice && bluetoothDevice.gatt.connected) {
          bluetoothDevice.gatt.disconnect();
          updateBluetoothStatus(false);
          return;
        }

        showStatus('loading', '🔍 Tìm máy in Y58...');
        
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [
            '000018f0-0000-1000-8000-00805f9b34fb',
            '0000ff00-0000-1000-8000-00805f9b34fb',
            '00001101-0000-1000-8000-00805f9b34fb',
            '0000180f-0000-1000-8000-00805f9b34fb'
          ]
        });

        showStatus('loading', `📶 Kết nối ${bluetoothDevice.name || 'Y58'}...`);

        const server = await bluetoothDevice.gatt.connect();
        const services = await server.getPrimaryServices();
        let foundCharacteristic = null;
        
        for (const service of services) {
          try {
            const characteristics = await service.getCharacteristics();
            foundCharacteristic = characteristics.find(c => 
              c.properties.write || c.properties.writeWithoutResponse
            );
            if (foundCharacteristic) break;
          } catch (e) {
            continue;
          }
        }

        if (!foundCharacteristic) {
          throw new Error('Không tìm thấy characteristic để in');
        }

        bluetoothCharacteristic = foundCharacteristic;
        
        bluetoothDevice.addEventListener('gattserverdisconnected', () => {
          updateBluetoothStatus(false);
          showStatus('error', '📶 Máy in đã ngắt kết nối');
        });
        
        updateBluetoothStatus(true, bluetoothDevice.name || 'Y58');
        showStatus('success', `✅ Đã kết nối ${bluetoothDevice.name || 'Y58'}!`);

      } catch (error) {
        console.error('Bluetooth error:', error);
        showError(`❌ Lỗi kết nối: ${error.message || 'Không thể kết nối Y58'}`);
        updateBluetoothStatus(false);
      }
    }

    function updateBluetoothStatus(connected, deviceName = '') {
      const status = document.getElementById('bluetoothStatus');
      const btn = document.getElementById('bluetoothBtn');
      
      if (connected) {
        status.innerHTML = `🟢 ${deviceName || 'Máy in'} đã kết nối`;
        status.classList.add('connected');
        btn.innerHTML = '<span>🔌</span> Ngắt kết nối';
      } else {
        status.innerHTML = '🔴 Bluetooth chưa kết nối';
        status.classList.remove('connected');
        btn.innerHTML = '<span>📶</span> Kết nối BT';
        bluetoothDevice = null;
        bluetoothCharacteristic = null;
      }
    }

    // ==================== PDF TO PRINT - TRIỆT ĐỂ ====================
    
    async function testPDFPrint() {
      if (!bluetoothCharacteristic) {
        alert('❌ Chưa kết nối máy in Y58!');
        return;
      }

      try {
        showStatus('loading', '📄 Đang tạo PDF test với tiếng Việt...');
        
        const testData = {
          name: 'NGUYỄN BẢO CHÍ',
          address: 'Phú Lợi A Phú, Thuận B Hồng Ngự, Đồng Tháp',
          phone: '0822845232',
          service: 'd067_gftth_langd0',
          content: 'Thu tiền internet',
          amount: 200000
        };
        
        const pdf = await createReceiptPDF(testData);
        await showPDFPreview(pdf);
        await printPDFToBluetooth(pdf);
        
        showStatus('success', '✅ Test PDF thành công! Kiểm tra máy in và preview.');
        
      } catch (error) {
        console.error('Test PDF error:', error);
        showError(`❌ Lỗi test PDF: ${error.message}`);
      }
    }

    // Tạo PDF với tiếng Việt có dấu
    async function createReceiptPDF(receiptData) {
      const { jsPDF } = window.jspdf;
      
      // Tạo PDF với kích thước 58mm (tương đương 164.4 points width)
      const pdfWidth = 58; // 58mm
      const pdfHeight = 100; // Auto height
      const pdf = new jsPDF({
        unit: 'mm',
        format: [pdfWidth, pdfHeight],
        orientation: 'portrait'
      });
      
      // Set font hỗ trợ tiếng Việt
      pdf.setFont('helvetica');
      
      let y = 5; // Starting Y position
      const leftMargin = 2;
      const lineHeight = 3.5;
      
      // Header - Center aligned
      pdf.setFontSize(10);
      pdf.text('viettel', pdfWidth/2, y, { align: 'center' });
      y += lineHeight;
      
      pdf.setFontSize(8);
      pdf.text('Theo cách của bạn', pdfWidth/2, y, { align: 'center' });
      y += lineHeight * 1.5;
      
      pdf.setFontSize(9);
      pdf.text('VIETTEL ĐỒNG THÁP', pdfWidth/2, y, { align: 'center' });
      y += lineHeight;
      
      pdf.setFontSize(10);
      pdf.setFont('helvetica', 'bold');
      pdf.text('BIÊN NHẬN', pdfWidth/2, y, { align: 'center' });
      y += lineHeight * 1.5;
      
      // Separator
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(6);
      pdf.text('================================', leftMargin, y);
      y += lineHeight;
      
      // Content - Left aligned
      pdf.setFontSize(7);
      
      // Tên khách hàng
      pdf.text('Tên khách hàng:', leftMargin, y);
      y += lineHeight;
      pdf.text(receiptData.name, leftMargin, y);
      y += lineHeight;
      
      // Địa chỉ
      pdf.text('Địa chỉ:', leftMargin, y);
      y += lineHeight;
      const addressLines = wrapTextForPDF(receiptData.address, 50);
      for (const line of addressLines) {
        pdf.text(line, leftMargin, y);
        y += lineHeight;
      }
      
      // Thuê bao
      pdf.text('Thuê bao:', leftMargin, y);
      y += lineHeight;
      pdf.text(receiptData.service, leftMargin, y);
      y += lineHeight;
      
      // Nội dung
      pdf.text('Nội dung:', leftMargin, y);
      y += lineHeight;
      pdf.text(receiptData.content, leftMargin, y);
      y += lineHeight;
      
      // Điện thoại liên hệ
      pdf.text('Điện thoại liên hệ:', leftMargin, y);
      y += lineHeight;
      pdf.text(receiptData.phone, leftMargin, y);
      y += lineHeight;
      
      // Ký cước
      pdf.text('Ký cước:', leftMargin, y);
      y += lineHeight;
      pdf.text(formatDateVietnam(new Date()), leftMargin, y);
      y += lineHeight * 1.5;
      
      // Số tiền
      pdf.text(`Số tiền: ${formatMoneyVietnam(receiptData.amount)}`, leftMargin, y);
      y += lineHeight;
      pdf.text(`Bằng chữ: ${numberToVietnameseWords(receiptData.amount)}`, leftMargin, y);
      y += lineHeight * 1.5;
      
      // Footer
      pdf.setFontSize(6);
      pdf.text('SĐT liên hệ: 0978887797', leftMargin, y);
      y += lineHeight;
      pdf.text('Tổng đài CSKH: 18008119', leftMargin, y);
      y += lineHeight * 2;
      
      pdf.text('Cảm ơn quý khách!', pdfWidth/2, y, { align: 'center' });
      
      return pdf;
    }

    // Show PDF preview
    async function showPDFPreview(pdf) {
      return new Promise((resolve) => {
        // Tạo preview container
        const previewDiv = document.createElement('div');
        previewDiv.className = 'pdf-preview';
        previewDiv.innerHTML = `
          <div class="pdf-preview-header">
            <h3>📄 PDF Preview - Tiếng Việt có dấu</h3>
            <button class="pdf-preview-close" onclick="this.parentElement.parentElement.remove(); arguments[0].stopPropagation();">×</button>
          </div>
          <div id="pdfContainer"></div>
          <div style="text-align: center; margin-top: 15px;">
            <button class="btn btn-success" onclick="this.parentElement.parentElement.remove(); arguments[0].stopPropagation();">
              ✅ OK - Tiếp tục in
            </button>
          </div>
        `;
        
        document.body.appendChild(previewDiv);
        
        // Convert PDF to canvas để preview
        const pdfDataUri = pdf.output('datauristring');
        const iframe = document.createElement('iframe');
        iframe.src = pdfDataUri;
        iframe.style.width = '100%';
        iframe.style.height = '400px';
        iframe.style.border = '1px solid #ddd';
        iframe.style.borderRadius = '8px';
        
        document.getElementById('pdfContainer').appendChild(iframe);
        
        // Auto resolve sau 2 giây hoặc khi click OK
        const okBtn = previewDiv.querySelector('.btn-success');
        okBtn.addEventListener('click', () => {
          previewDiv.remove();
          resolve();
        });
        
        setTimeout(resolve, 3000); // Auto continue sau 3s
      });
    }

    // Print PDF to Bluetooth
    async function printPDFToBluetooth(pdf) {
      try {
        console.log('📄 Converting PDF to bitmap...');
        
        // Convert PDF to canvas
        const canvas = await pdfToCanvas(pdf);
        
        // Convert canvas to monochrome bitmap
        const bitmapData = canvasToMonochromeBitmap(canvas);
        
        // Convert bitmap to ESC/POS commands
        const escPosCommands = bitmapToESCPOS(bitmapData, canvas.width, canvas.height);
        
        console.log('📡 Sending', escPosCommands.length, 'bytes to printer...');
        
        // Send to Y58 printer
        await sendRawBytes(escPosCommands);
        
        console.log('✅ PDF printed successfully!');
        
      } catch (error) {
        console.error('❌ PDF print error:', error);
        throw new Error('Lỗi in PDF: ' + error.message);
      }
    }

    // Convert PDF to Canvas
    async function pdfToCanvas(pdf) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Kích thước cho máy in 58mm (384 pixels width)
      const printWidth = 384;
      canvas.width = printWidth;
      
      // Get PDF as image data
      const imgData = pdf.output('datauristring');
      
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
          // Tính toán height để maintain aspect ratio
          const aspectRatio = img.height / img.width;
          canvas.height = printWidth * aspectRatio;
          
          // Clear canvas với màu trắng
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          // Draw PDF image
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          
          resolve(canvas);
        };
        img.src = imgData;
      });
    }

    // Convert canvas to monochrome bitmap
    function canvasToMonochromeBitmap(canvas) {
      const ctx = canvas.getContext('2d');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const pixels = imageData.data;
      
      const bitmap = [];
      
      for (let y = 0; y < canvas.height; y++) {
        const row = [];
        for (let x = 0; x < canvas.width; x++) {
          const i = (y * canvas.width + x) * 4;
          const r = pixels[i];
          const g = pixels[i + 1];
          const b = pixels[i + 2];
          
          // Convert to grayscale
          const gray = (r + g + b) / 3;
          
          // Threshold to black/white (1 = black, 0 = white)
          const bit = gray < 128 ? 1 : 0;
          row.push(bit);
        }
        bitmap.push(row);
      }
      
      return bitmap;
    }

    // Convert bitmap to ESC/POS commands
    function bitmapToESCPOS(bitmap, width, height) {
      const commands = [];
      
      // Reset printer
      commands.push(0x1B, 0x40); // ESC @
      
      // Set line spacing to 0
      commands.push(0x1B, 0x33, 0x00); // ESC 3 0
      
      // Process bitmap in 8-pixel high bands
      for (let y = 0; y < height; y += 8) {
        // ESC * m nL nH - Print raster bitmap
        commands.push(0x1B, 0x2A, 0x00); // ESC * 0 (single density)
        
        // Width bytes (little endian)
        const widthBytes = Math.ceil(width / 8);
        commands.push(widthBytes & 0xFF, (widthBytes >> 8) & 0xFF);
        
        // Generate bitmap data for this band
        for (let x = 0; x < width; x += 8) {
          let byte = 0;
          
          for (let bit = 0; bit < 8; bit++) {
            const px = x + bit;
            if (px < width && y < height && bitmap[y] && bitmap[y][px]) {
              byte |= (1 << (7 - bit));
            }
          }
          
          commands.push(byte);
        }
        
        // Line feed
        commands.push(0x0A);
      }
      
      // Restore line spacing
      commands.push(0x1B, 0x32); // ESC 2
      
      // Feed paper
      commands.push(0x0A, 0x0A, 0x0A);
      
      return new Uint8Array(commands);
    }

    // Send raw bytes với chunk control
    async function sendRawBytes(bytes) {
      const chunkSize = 20;
      
      for (let i = 0; i < bytes.length; i += chunkSize) {
        const chunk = bytes.slice(i, i + chunkSize);
        
        if (bluetoothCharacteristic.properties.writeWithoutResponse) {
          await bluetoothCharacteristic.writeValueWithoutResponse(chunk);
        } else {
          await bluetoothCharacteristic.writeValue(chunk);
        }
        
        await sleep(50); // Delay giữa các chunk
      }
    }

    // Print receipt PDF
    async function printReceiptPDF(receiptData) {
      try {
        showStatus('loading', '📄 Đang tạo PDF phiếu thu...');
        
        const pdf = await createReceiptPDF(receiptData);
        
        showStatus('loading', '🖨️ Đang in PDF...');
        
        await printPDFToBluetooth(pdf);
        
        showStatus('success', `✅ Đã in PDF thành công cho ${receiptData.name}!`);
        
      } catch (error) {
        console.error('Print receipt PDF error:', error);
        throw new Error('Lỗi in PDF: ' + error.message);
      }
    }

    // ==================== GOOGLE SHEETS (unchanged) ====================
    
    async function testConnection() {
      const sheetId = document.getElementById('sheetId').value.trim();
      if (!sheetId) {
        alert('❌ Vui lòng nhập Sheet ID!');
        document.getElementById('sheetId').focus();
        return;
      }

      showStatus('loading', '🔧 Kiểm tra kết nối Google Sheets...');
      hideError();

      try {
        const data = await fetchSheetData();
        showStatus('success', `✅ Kết nối thành công! Tìm thấy ${data.length - 1} bản ghi`);
        setTimeout(() => loadData(), 1500);
      } catch (error) {
        showError(`❌ Lỗi kết nối Google Sheets: ${error.message}\n\n💡 Kiểm tra:\n• Sheet ID có đúng không?\n• Sheet có chia sẻ công khai không?\n• Tên sheet có đúng không?`);
      }
    }

    async function fetchSheetData() {
      const sheetId = document.getElementById('sheetId').value.trim();
      const sheetName = document.getElementById('sheetName').value.trim() || 'Sheet1';
      
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Accept': 'text/csv,application/csv',
        }
      });
      
      if (!response.ok) {
        if (response.status === 400) {
          throw new Error('Sheet ID không hợp lệ hoặc không tồn tại');
        } else if (response.status === 403) {
          throw new Error('Sheet chưa được chia sẻ công khai. Hãy vào Google Sheets > Share > Anyone with link can view');
        } else {
          throw new Error(`HTTP ${response.status}: Không thể tải dữ liệu`);
        }
      }
      
      const csvText = await response.text();
      
      if (!csvText || csvText.trim() === '') {
        throw new Error('Sheet trống hoặc tên sheet không đúng');
      }
      
      return parseCSV(csvText);
    }

    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(line => line.trim());
      return lines.map(line => {
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim());
        return values;
      });
    }

    async function loadData() {
      showStatus('loading', '📊 Đang tải dữ liệu từ Google Sheets...');
      hideError();

      try {
        const data = await fetchSheetData();
        if (data.length === 0) {
          showStatus('error', '📭 Sheet trống hoặc không có dữ liệu');
          return;
        }

        const headers = data[0];
        const rows = data.slice(1).filter(row => 
          row.some(cell => cell && cell.toString().trim() !== '')
        );
        
        allRecords = rows.map((row, index) => ({
          rowIndex: index + 2,
          data: row,
          headers: headers
        }));

        displayRecords();
        showStatus('success', `📄 Đã tải thành công ${allRecords.length} bản ghi`);

      } catch (error) {
        showError(`❌ Lỗi tải dữ liệu: ${error.message}`);
      }
    }

    function displayRecords() {
      const container = document.getElementById('records');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      
      let filteredRecords = allRecords;
      if (searchTerm) {
        filteredRecords = allRecords.filter(record => 
          record.data.some(cell => 
            cell && cell.toString().toLowerCase().includes(searchTerm)
          )
        );
      }

      if (filteredRecords.length === 0) {
        container.innerHTML = '<div class="status">📭 Không tìm thấy dữ liệu phù hợp</div>';
        return;
      }

      container.innerHTML = filteredRecords.map(record => {
        const row = record.data;
        const headers = record.headers;
        
        const nameIdx = findColumnIndex(headers, ['tên', 'khách hàng', 'name']);
        const addressIdx = findColumnIndex(headers, ['địa chỉ', 'address', 'diachi']);
        const phoneIdx = findColumnIndex(headers, ['điện thoại', 'phone', 'sdt', 'dienthoai', 'liên hệ']);
        const serviceIdx = findColumnIndex(headers, ['thuê bao', 'service', 'thuebao', 'dịch vụ']);
        const contentIdx = findColumnIndex(headers, ['nội dung', 'content', 'noidung', 'ghi chú', 'ghichu']);
        const amountIdx = findColumnIndex(headers, ['tiền', 'số tiền', 'sotien', 'amount', 'money', 'thành tiền']);
        const printedIdx = findColumnIndex(headers, ['đã in', 'printed', 'dain', 'status']);
        const invoiceIdx = findColumnIndex(headers, ['mã', 'hóa đơn', 'invoice', 'id', 'mahd']);
        
        const name = row[nameIdx] || 'N/A';
        const address = row[addressIdx] || 'N/A';
        const phone = row[phoneIdx] || 'N/A';
        const service = row[serviceIdx] || 'N/A';
        const content = row[contentIdx] || 'Thu tiền internet';
        const amount = parseFloat((row[amountIdx] || '0').toString().replace(/[^\d.-]/g, '')) || 0;
        const printed = (row[printedIdx] || '').toString().toLowerCase().includes('đã in');
        const invoice = row[invoiceIdx] || '';
        
        return `
          <div class="record ${printed ? 'printed' : ''}">
            <div class="record-info">
              <div class="record-name">
                👤 ${name}
                ${printed ? '<span style="color: #27ae60; font-size: 20px;">✅</span>' : ''}
              </div>
              <div class="record-details">
                <div><strong>📍 Địa chỉ:</strong> ${address}</div>
                <div><strong>📞 Điện thoại:</strong> ${phone}</div>
                <div><strong>📡 Thuê bao:</strong> ${service}</div>
                <div><strong>📝 Nội dung:</strong> ${content}</div>
                ${invoice ? `<div><strong>🏷️ Mã HĐ:</strong> ${invoice}</div>` : ''}
              </div>
            </div>
            <div class="record-actions">
              <div class="amount">💰 ${formatMoney(amount)}</div>
              ${printed ? 
                '<div class="print-status">✅ Đã in rồi</div>' : 
                `<button class="btn btn-danger" onclick="printReceiptPDFWrapper('${escapeQuotes(name)}', '${escapeQuotes(address)}', '${phone}', '${escapeQuotes(service)}', '${escapeQuotes(content)}', ${amount}, '${invoice}', ${record.rowIndex})">
                  <span>📄</span> In PDF
                </button>`
              }
            </div>
          </div>
        `;
      }).join('');
    }

    function findColumnIndex(headers, possibleNames) {
      for (const name of possibleNames) {
        const index = headers.findIndex(header => 
          header && header.toLowerCase().includes(name.toLowerCase())
        );
        if (index !== -1) return index;
      }
      return -1;
    }

    function escapeQuotes(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    async function printReceiptPDFWrapper(name, address, phone, service, content, amount, invoice, rowIndex) {
      if (!bluetoothCharacteristic) {
        if (confirm('❌ Chưa kết nối máy in Y58!\n\n📶 Bạn có muốn kết nối ngay không?')) {
          await connectBluetooth();
          if (!bluetoothCharacteristic) return;
        } else {
          return;
        }
      }

      try {
        await printReceiptPDF({
          name, address, phone, service, content, amount, invoice
        });

      } catch (error) {
        console.error('Print error:', error);
        showError(`❌ Lỗi in phiếu: ${error.message}`);
      }
    }

    // ==================== HELPER FUNCTIONS ====================

    function search() {
      if (allRecords.length === 0) {
        alert('⚠️ Chưa tải dữ liệu. Hãy nhấn "Test Sheet" trước!');
        return;
      }
      displayRecords();
    }

    function loadAll() {
      document.getElementById('searchInput').value = '';
      if (allRecords.length === 0) {
        loadData();
      } else {
        displayRecords();
      }
    }

    // Format ngày theo chuẩn Việt Nam
    function formatDateVietnam(date) {
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `Tháng ${month}/${year}`;
    }

    // Format tiền tệ Việt Nam
    function formatMoneyVietnam(amount) {
      if (!amount || amount === 0) return '0 đ';
      return new Intl.NumberFormat('vi-VN').format(amount) + ' đ';
    }

    function formatMoney(amount) {
      if (!amount || amount === 0) return '0 đ';
      return new Intl.NumberFormat('vi-VN', {
        style: 'currency', 
        currency: 'VND'
      }).format(amount).replace('₫', 'đ');
    }

    // Chuyển số thành chữ tiếng Việt có dấu
    function numberToVietnameseWords(num) {
      if (!num || num === 0) return 'Không đồng';
      
      const ones = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
      const tens = ['', 'mười', 'hai mười', 'ba mười', 'bốn mười', 'năm mười', 
                   'sáu mười', 'bảy mười', 'tám mười', 'chín mười'];
      const scales = ['', 'nghìn', 'triệu', 'tỷ'];
      
      function convertHundreds(n) {
        let result = '';
        
        if (n >= 100) {
          result += ones[Math.floor(n / 100)] + ' trăm ';
          n %= 100;
        }
        
        if (n >= 20) {
          const tenDigit = Math.floor(n / 10);
          result += (tenDigit === 1 ? 'mười' : ones[tenDigit] + ' mười') + ' ';
          n %= 10;
        } else if (n >= 10) {
          result += 'mười ';
          n %= 10;
        }
        
        if (n > 0) {
          if (n === 5 && result.includes('mười')) {
            result += 'lăm ';
          } else {
            result += ones[n] + ' ';
          }
        }
        
        return result;
      }
      
      let result = '';
      let scaleIndex = 0;
      
      while (num > 0) {
        const chunk = num % 1000;
        if (chunk !== 0) {
          const chunkText = convertHundreds(chunk);
          result = chunkText + scales[scaleIndex] + ' ' + result;
        }
        num = Math.floor(num / 1000);
        scaleIndex++;
      }
      
      result = result.trim().replace(/\s+/g, ' ');
      result = result.charAt(0).toUpperCase() + result.slice(1);
      
      return result + ' đồng.';
    }

    // Wrap text for PDF
    function wrapTextForPDF(text, maxLength) {
      if (text.length <= maxLength) return [text];
      
      const words = text.split(' ');
      const lines = [];
      let currentLine = '';
      
      for (const word of words) {
        if ((currentLine + word).length > maxLength && currentLine) {
          lines.push(currentLine.trim());
          currentLine = word + ' ';
        } else {
          currentLine += word + ' ';
        }
      }
      
      if (currentLine.trim()) {
        lines.push(currentLine.trim());
      }
      
      return lines;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function showStatus(type, message) {
      const status = document.getElementById('status');
      status.className = `status ${type}`;
      status.textContent = message;
      status.style.display = 'block';
    }

    function showError(message) {
      const error = document.getElementById('error');
      error.textContent = message;
      error.style.display = 'block';
      document.getElementById('status').style.display = 'none';
    }

    function hideError() {
      document.getElementById('error').style.display = 'none';
    }
  </script>
</body>
</html>
